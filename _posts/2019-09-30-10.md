---
layout: episode
title: "10: å–¬å–¬ escaping"
description: weak self podcast
date: 2019-09-29 22:30:00 +0800
categories: 
---
<iframe src="https://anchor.fm/weakself/embed/episodes/10--escaping-e5l7p6" height="102px" width="400px" frameborder="0" scrolling="no"></iframe>
æœ¬é›†ç«Ÿç„¶æœ‰äºº escapeï¼é‚£æˆ‘å€‘å°±é †å‹¢ä¾†å›æ‡‰èˆ‡ @escaping æœ‰é—œçš„ [#weakselfæŒ‘æˆ°è³½](https://twitter.com/hashtag/weakselfæŒ‘æˆ°è³½)å§ï¼ç‚ºä»€éº¼ Swift closure çš„ [weak self] è¦åŠ ä¸­æ‹¬è™Ÿå‘¢ï¼Ÿweakã€unowned ä½ åˆ†å¾—æ¸…æ¥šå·®åˆ¥å—ï¼Ÿä¸€èµ·ä¾†åƒèˆ‡æŒ‘æˆ°å§ã€‚

## weak self æŒ‘æˆ°è³½

* å°ç¶ çš„æŒ‘æˆ°[æ¨æ–‡](https://twitter.com/handkid/status/1174669625579032578?s=20)
* ä½•è¬‚ escapingã€nonescaping closure
* ä½•æ™‚ç”¨ weakã€unownedï¼Œæˆ–æ˜¯ä¸ç”¨

## Closure çš„è¡Œç‚º

* æ­é…æœç”¨çš„[ç¨‹å¼ç¯„ä¾‹](https://gist.github.com/pofat/0c5d0ab99c95bb7b9663b57b550feea4)
* closure é è¨­æœƒ capture (strong reference) å¤–éƒ¨è®Šæ•¸
* capture list æœƒç”Ÿæˆä¸€ä»½ copy

## Escaping å’Œ Nonescaping

* function return å¾Œé‚„æœƒç™¼ç”Ÿçš„å«åš escaping
* æœ‰æ©Ÿæœƒé€ æˆ retain cycle

## Weak å’Œ Unowned çš„é‹ä½œåŸç†

* Swift çš„ reference instance æ˜¯å€‹ HeapObject
* [HeapObject](https://github.com/apple/swift/blob/4fd0671e542299d7805e41cf9426640ab3b399af/stdlib/public/SwiftShims/HeapObject.h#L45)
* weak reference æœƒç‚º instance å»ºç«‹ side table ç”¨ä¾†è¨ˆç®—æ•¸ç›®
* [Swift Ownership Manifesto](https://github.com/apple/swift/blob/master/docs/OwnershipManifesto.md)
* [Objective-C çš„ ARC åŠŸèƒ½å¦‚æœä¸æ˜¯å› ç‚ºå‰µç«‹å…¨æ–°èªè¨€ Swift æ™‚è¿½æ±‚ memory safetyï¼Œææ€•å¾ä¾†ä¸æœƒå‡ºç¾ã€‚](https://twitter.com/ethanhuang13/status/1099200155318767616)æœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥å»è½ [The Swift Community Podcast Ep.1](https://www.swiftcommunitypodcast.org/episodes/1)ã€‚

## ä½•æ™‚ç”¨ weak æˆ–æ˜¯ unownedï¼Ÿ

* closure ç”Ÿå‘½é€±æœŸèˆ‡å°è±¡ç”Ÿå‘½å‘¨æœŸä¸€è‡´æ™‚ï¼Œä½¿ç”¨ unowned
* weak æœ‰è¼ƒå¤šè¨˜æ†¶é«”æ¶ˆè€—
* è¦äº†è§£ç¨‹å¼ç¢¼è£¡å¤§å®¶çš„ç”Ÿå‘½å‘¨æœŸå•Š

## æŒ‘æˆ°è³½å°çµ

* closure æœƒæ•æ‰å¤–éƒ¨ä½¿ç”¨çš„è®Šæ•¸ï¼Œæœ‰å¯èƒ½é€ æˆ retain cycle
* weak å’Œ unowned æœ‰ä¸åŒçš„æ©Ÿåˆ¶èˆ‡ç”Ÿå‘½é€±æœŸ
* æ²’æœ‰ retain cycle ä¸ç”¨ weak / unowned
* weak æœ‰é¡å¤–çš„è¨˜æ†¶é«”èˆ‡æ€§èƒ½æ¶ˆè€—ï¼ˆå¯å¿½ç•¥ï¼‰

## å·¥ç¨‹å¸«çš„ escape

* [æœ€å¾Œç”Ÿé‚„è€… Part II](https://asia.playstation.com/cht-tw/games/the-last-of-us-part-ii-ps4/)

## 13 æœ€è¿‘åœ¨ç© Apple Arcade
* 13 çš„ Apple [#ArcadeReview](https://twitter.com/search?q=%23ArcadeReview%20%40ethanhuang13) é€£è¼‰ä¸­
* iPad mini è¶…é©åˆç© Apple Arcade çš„ï¼Œåˆè¼•åˆå¿«åˆå¹³ğŸ’¸

## æœ¬é›†æ’­å‡ºå¾Œçš„å¾ŒçºŒè¨è«–èˆ‡å…§å®¹æ›´æ­£

æœ¬é›†å…§å®¹æ’­å‡ºå¾Œï¼Œæœ‰æ¨å‹å‘æˆ‘å€‘å›é¥‹æœ‰äº›å…§å®¹è§€å¿µæ··æ·†ä¹Ÿæå‡ºäº†æ­£ç¢ºå’Œæ¸…æ¥šçš„èªªæ³•ï¼Œéå¸¸æ„Ÿè¬é€™äº›æ¨å‹å€‘ï¼Œæˆ‘å€‘éå¸¸æ¨‚è¦‹é€™æ¨£çš„~~æŠ“æ¼~~è¨è«–ï¼é€™äº›è¨è«–å’Œæ›´æ­£æ•´ç†å¦‚ä¸‹ï¼š

### Swift çš„ closure èˆ‡ ObjectiveC çš„ block

é€™è£¡åœ¨ç¯€ç›®å’Œå¾ŒçºŒè¨è«–ä¸­æŠŠå…©å€‹æ±è¥¿æ··åœ¨ä¸€èµ·èªªï¼Œå…©è€…ä¹‹é–“çš„å·®ç•°å¦‚ä¸‹ï¼š
* Swift çš„ closure æ˜¯ reference typeï¼Œä¸éœ€è¦é—œå¿ƒ copy æˆ–åœ¨ heap ã€ stack çš„å•é¡Œ
* OC è£¡çš„ block æœ‰ stack / global / heap ä¸‰ç¨®ï¼ŒARC çš„ç’°å¢ƒä¸­åŸºæœ¬ä¸Šæ²’æœ‰ stack block
* OC è£¡çš„ block copy ï¼Œå° stack block æœƒå°‡å®ƒç§»åˆ° heap ä¸Šï¼Œå·²åœ¨ heap çš„å°±æ˜¯ retain count åŠ ä¸€
* OC è£¡çš„ block æ²’æœ‰ escaping çš„æ¦‚å¿µ
* Twitter [åŸæ–‡1](https://twitter.com/kylinroc/status/1178563238008508417?s=20)ï¼Œ[åŸæ–‡2](https://twitter.com/kylinroc/status/1178564220507451393?s=20)

### weak ä»¥åŠ unowned çš„ä½¿ç”¨ç­–ç•¥

æ¨å‹æåˆ°å¦ä¸€å€‹å¾ˆå¥½çš„åˆ‡å…¥è§€é»ï¼Œå¾ç¨‹å¼ç¢¼çš„ç¶­è­·è§€é»å‡ºç™¼ï¼Œç•¶ç¨‹å¼è¿­ä»£ï¼Œç”Ÿå‘½å‘¨æœŸå’Œå¾å±¬é—œä¿‚å¯èƒ½ç™¼ç”Ÿè®ŠåŒ–ï¼Œè€Œé€™äº› unowned å¯èƒ½å¸¶ä¾†ç¶­è­·ä¸Šçš„è² æ“”ï¼Œè©³è¦‹ Twitter [åŸæ–‡](https://twitter.com/kemchenj/status/1178908092286652416?s=20)ã€‚

### Swift è£¡çš„ Ownership ææ¡ˆèˆ‡ç¾æ³

åœ¨ç¯€ç›®æåˆ°é€™å€‹æ™‚æˆ‘çš„äº†è§£éƒ½æ˜¯ä¾†è‡ªæ–¼å’Œå‹äººçš„è¨è«–ï¼Œé¡¯ç„¶æœ‰äº›åœ°æ–¹è¬›å¾—ä¸æ­£ç¢ºï¼Œå°‡æ­£ç¢ºçš„è§€å¿µèˆ‡ç¾æ³æ•´ç†å¦‚ä¸‹ï¼š

* Ownership çš„æ¦‚å¿µå…¶å¯¦å¾ˆç°¡å–®ï¼Œå¤§æ„æ˜¯ instance éƒ½æœ‰è‡ªå·±çš„ ownerï¼Œç•¶ owner çš„ lifetime çµæŸï¼Œé€™å€‹ instance æ‡‰è©²ä¹Ÿè¦éš¨ä¹‹éŠ·æ¯€
* Rust å·²ç¶“æœ‰éå¸¸å®Œæ•´çš„å¯¦åšï¼Œå¯ä»¥åœ¨è¨˜æ†¶é«”ä¸Šæœ‰æ›´å®‰å…¨çš„ä¿è­‰ï¼Œæœ‰å¹¾é»æ˜¯ç›®å‰ Swift ç„¡æ³•ä¿è­‰çš„å®‰å…¨å•é¡Œï¼š
    * Dangling pointer
    * Free after use
    * Strong reference (retain) cycle
* Ownership åœ¨ Swift çš„å¯¦ä½œå…¶å¯¦å°±æ˜¯é«”ç¾åœ¨ ARC è£¡çš„ strong referenceï¼Œé€™è£¡å°±æ˜¯æˆ‘å€‘ç†Ÿæ‚‰çš„ï¼Œç•¶ retain count è®Šæˆ 0ï¼Œinstance å°±æœƒè¢«éŠ·æ¯€ï¼Œé€™è£¡æ˜¯å¯¦ä½œåœ¨ Swift èªè¨€æœ¬èº«çš„æ©Ÿåˆ¶ï¼Œä¹Ÿæ˜¯æˆ‘å€‘æœ¬é›†çš„ä¸»è¦å…§å®¹ã€‚
* Ownership [manifesto](https://github.com/apple/swift/blob/master/docs/OwnershipManifesto.md) ææ¡ˆå…§å®¹æ˜¯åœ¨ä¸€èˆ¬é–‹ç™¼è€…ç„¡æ„Ÿçš„åº•å±¤å¯¦ä½œï¼ˆARCï¼‰ä¹‹å¤–ï¼Œæä¾›è®“é–‹ç™¼è€…ä»¥åŠ æ¨™ç±¤çš„æ–¹å¼ï¼ˆsharedã€moveOnly ç­‰ï¼‰ä»¥ä½¿ç”¨ ownership çš„åŠŸèƒ½ï¼Œé€™äº›åŠŸèƒ½æœ€ä¸»è¦éƒ½åœç¹åœ¨ç¨ä½”æ€§åŸå‰‡ï¼ˆLaw of Exclusivityï¼‰
* æ‰¿ä¸Šï¼ŒSwift è£¡ä¸»è¦æƒ³è§£æ±ºçš„å•é¡Œåœ¨ copy çš„æ€§èƒ½å•é¡Œï¼Œä¸»è¦æ˜¯é‡å° struct çš„ copy on write
* ç…§ manifesto è£¡çš„å…§å®¹ï¼Œè‹¥è¦é‹ç”¨å‹¢å¿…æœƒå°ç¾è¡Œçš„ç¨‹å¼ç¢¼å¸¶ä¾†æ”¹è®Šï¼Œä½†ä»–å€‘æœ‰ä¸€å†å¼·èª¿æ”¹è®Šæœƒç›¡é‡å°ä¸”å¿…è¦ï¼ˆbut who knowsï¼‰
* è€Œä¸”æ‡‰è©²æ˜¯è¦å’Œ ARC å…±å­˜ï¼Œä¸¦ä¸æ˜¯å–ä»£ï¼ˆé€™æ˜¯æˆ‘å€‹äººè®€å®Œçš„è¦‹è§£ï¼‰
* å°±æˆ‘æ‰€çŸ¥ç›®å‰æ‡‰è©²å°šæœªæœ‰å¯ç”¨çš„å¯¦ä½œ
* åƒè€ƒè³‡æ–™ï¼š[æ¨å‹åŸæ–‡](https://twitter.com/kemchenj/status/1178909418261319680?s=20)ï¼Œä¸€ç¯‡åˆ†æ ownership åœ¨ Rust èˆ‡ Swift å·®ç•°çš„[è«–æ–‡](https://macsphere.mcmaster.ca/handle/11375/23625)

## æ›´å¤š weak self

* ä¸»è¬›äºº [ä¸€ä¸‰](https://twitter.com/ethanhuang13)ã€[æ³¢è‚¥](https://twitter.com/PofatTseng)ã€[å–¬å–¬](https://twitter.com/joe_trash_talk)
* å®˜ç¶² [https://weakself.dev](https://weakself.dev)
* Twitter [@weak_self](https://twitter.com/weak_self)
* [æå•ç®±](https://peing.net/zh-TW/weak_self)
