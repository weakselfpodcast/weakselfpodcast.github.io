---
layout: episode
title: "13: å–¬å–¬ Erasure"
description: weak self podcast
date: 2019-10-22 00:00:00 +0800
categories: 
---
<iframe src="https://www.listennotes.com/embedded/e/39ba39131dc74ddda65e53cc37921b63/" width="100%" style="width: 1px; min-width: 100%;" frameborder="0" scrolling="no"></iframe>

åˆæ˜¯æ­¡æ¨‚çš„ä¸€é›†ï¼ä»Šå¤©èŠèµ· [#weakselfæŒ‘æˆ°è³½](https://twitter.com/hashtag/weakselfæŒ‘æˆ°è³½)çš„ Type Erasure èˆ‡ Opaque Return Typeã€‚ä¸éï¼Œæ€éº¼æŸäººçš„è²éŸ³åˆ°å¾ŒåŠæ®µå°± erased äº†ï¼ï¼Ÿ

## é–‹å ´

* ä¸Šä¸€é›†æˆç‚ºæœ€ç†±é–€é›†æ•¸ï¼Œæ‰€ä»¥è·Ÿæ–°æœ‹å‹æ‰“æ‹›å‘¼ã€è§£é‡‹ä¸€ä¸‹æˆ‘å€‘çš„åç¨±
* weak self é€™å€‹åç¨±ï¼Œå¯« Swift æˆ– iOS å·¥ç¨‹å¸«ä¸€çœ‹å°±çŸ¥é“ã€‚ä½†æˆ‘å€‘å…¶å¯¦æ²’æœ‰ä¸­æ–‡åç¨±ï¼Œå¤§å®¶å¯ä»¥å¹«å¿™æƒ³
* weak self, strong community
    * æ˜¨å¤©å¾—çŸ¥æŸäººé–“æ¥é€éç¤¾ç¾¤æ‰¾åˆ°å·¥ä½œ
* éµäººè³½
    * [iOS Developer Learning Android ç³»åˆ—](https://ithelp.ithome.com.tw/users/20117052/ironman/2191) by [@MarkFlyyyyy](https://twitter.com/MarkFlyyyyy)
    * [30 å¤©äº†è§£ Swift çš„ Combine](https://ithelp.ithome.com.tw/users/20119945/ironman/2272)
    * [æœ€é«˜è§€çœ‹æ•¸ bugï¼Ÿ](https://ithelp.ithome.com.tw/articles/10217609?sc=iThelpR)
    * å…¶ä»–æ•´ç†è«‹è¦‹[Â«13çš„é–‹ç™¼è€…é€±å ±Â»](https://ethanhuang13.substack.com/p/12)

* [xcode-install](https://github.com/xcpretty/xcode-install)

## æˆ‘æ¨ PAT

* PAT æŒ‡çš„æ˜¯  Protocol with Associated Typeï¼Œå¦‚ä¸‹ï¼š

```swift
// æœ‰ associatedtype çš„ protocol
public protocol IteratorProtocol {
  associatedtype Element
  mutating func next() -> Element?
}

// æœ‰ Self çš„ protocol, Hashable çš„ Self ä¾†è‡ªæ‰€ç¹¼æ‰¿çš„ Equatable
public protocol Hashable: Equatable {
  var hashValue: Int { get }
  func hash(into hasher: inout Hasher)
  func _rawHashValue(seed: Int) -> Int
}

public protocol Equatable {
  static func == (lhs: Self, rhs: Self) -> Bool
}
```

### ä½ æ˜¯å¿˜è¨˜é‚„æ˜¯å®³æ€•æƒ³èµ·ï¼Ÿ

![compile error](/assets/img/can_only_be_used_as_a_generic_constraint.png)

```swift
// ä»¥ä¸‹å¯«æ³•éƒ½æœƒè¢« compiler æŠ±æ€¨

// æœ‰ Self
func generateDictionaryKey() -> Hashable {
  return 8
}

// æœ‰ associatedtype
func getIterator() -> IteratorProtocol {
    return ["1", "2", "3"].makeIterator()
}
 
```

* PAT ä¸‰ä¸èƒ½ï¼š
    * ä¸èƒ½åšç‚ºè®Šæ•¸å‹åˆ¥ç”¨
    * ä¸èƒ½åšç‚º function çš„ return
    * ä¸èƒ½æ”¾åœ¨ Collection è£¡

## Type Erasure ç‚ºä½•è€Œç”Ÿ

PAT é›£æçš„åœ°æ–¹æœ‰å…©ç¨®ï¼š
1. æœ‰ `Self` çš„ Protocolï¼š`Hashable`
2. æœ‰ `associatedtype` çš„ Protocolï¼š`IteratorProtocol`

å°æ‡‰çš„åšæ³•:
* `AnyHashable`ï¼šé»‘é­”æ³• C++
* å° `AnyHashable` æœ‰èˆˆè¶£è«‹[å³è½‰](https://github.com/apple/swift/blob/master/stdlib/public/core/AnyHashable.swift)
* `AnyIterator` ç”¨ generic struct è§£æ±ºï¼Œå¦‚ä¸‹ï¼š

```swift
// åˆ©ç”¨ init with closure ä¾†è‡ªå‹•ä»£å…¥ `Element` çœŸå¯¦çš„å‹åˆ¥ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ <æŸå‹åˆ¥> çš„æ–¹å¼ä¾†æŒ‡å®š
// å…ˆå®£å‘Šä¸€å€‹ generic struct
struct MyAnyIterator<Element> {
    // å…§éƒ¨ä½¿ç”¨çš„ Box ï¼Œè£¡é¢å°±æ˜¯æŠŠ closure å­˜èµ·ä¾†ï¼Œæœ¬èº«ä¹Ÿæ»¿è¶³  IteratorProtocol
    private class AnyIteratorBox<Element>: IteratorProtocol {
        typealias Base = () -> Element?
        private var _base: Base

        init(_ base: @escaping Base) {
            self._base = base
        }

        func next() -> Element? {
            return _base()
        }
    }

    // æŠŠ closure åŒ…èµ·ä¾†çš„ box ( ç°¡å–®ä¸€é»ä¹Ÿå¯è®“ box å°±æ˜¯å€‹ closure type ç›´æ¥å­˜ closure)
    private let box: AnyIteratorBox<Element>
    init(_ body: @escaping () -> Element?) {
        self.box = AnyIteratorBox(body)
    }
}

// å†è®“æœ¬èº«æ»¿è¶³ IteratorProtocol
extension MyAnyIterator: IteratorProtocol {
    mutating func next() -> Element? {
        return box.next()
    }
}

// Fibonacci iterator
// å¯ä»¥çœ‹åˆ°æˆ‘å€‘ä»ç„¶è¦åœ¨å¤–éƒ¨å®šç¾©å¥½ closure èˆ‡å®ƒçš„ return type ä¾†æ±ºå®š Element
var state = (0, 1)
var myIterator = MyAnyIterator { () -> Int in
    let upcomingNumber = state.0
    state = (state.1, state.0 + state.1)
    return upcomingNumber
}

// Xcode æŒ‰ option + å·¦éµæœƒçœ‹åˆ° myIterator æ˜¯ MyAnyIterator<Int>
print(myIterator.next()) // 0
print(myIterator.next()) // 1
print(myIterator.next()) // 1
print(myIterator.next()) // 2
print(myIterator.next()) // 3
print(myIterator.next()) // 5
```

## Opaque Return Type

* weakself çš„ä¸­æ–‡åç¨±æ˜¯å€‹ Opaque Type (Caller æ±ºå®š generic æ˜¯ä»€éº¼)
* Opaque Return Type å‰‡ç”± Callee æ±ºå®š generic æ˜¯ä»€éº¼
* é¿å… *generiception*ï¼š

```swift
public typealias LazyCompactMapCollection<Elements, ElementOfResult>
  -> <C: Collection> C where C.Element == ElementOfResult
  = LazyMapSequence<LazyFilterSequence<LazyMapSequence<Elements, ElementOfResult?>>, ElementOfResult>
```
* ä¹Ÿæ˜¯å°æ–¼ Type Erasure çš„ä¸€ç¨®æ ¹æœ¬æ€§è§£æ±ºæ‰‹æ³•

```swift
// æƒ³åƒä»¥ä¸‹ function å®šç¾©åœ¨æŸä¸€å€‹ module è£¡ï¼Œå¤–éƒ¨ç„¡æ³•æ±ºå®š Element æ˜¯ä»€éº¼
// æ­¤ func ä½ å¯ä»¥å‘¼å«ä½†è£¡é¢å¯¦ä½œçœ‹ä¸åˆ°
func getIterator() -> some IteratorProtocol {
    var state = (0, 1)
    return MyAnyIterator { () -> Int in
        let upcomingNumber = state.0
        state = (state.1, state.0 + state.1)
        return upcomingNumber
    }
}

// ä»¥ä¸‹æ˜¯æˆ‘å€‘åœ¨å¤–éƒ¨å‘¼å«ï¼Œåœ¨å¤–é¢å‘¼å«çš„äººåªçŸ¥é“å®ƒæ˜¯ some IteratorProtocol
// å¾ Xcode çš„æç¤ºåªçŸ¥é“ someIterator å‹åˆ¥æ˜¯ `some IteratorProtocol`
var someIterator = getIterator()

print(someIterator.next())
print(someIterator.next())
print(someIterator.next())
print(someIterator.next())
print(someIterator.next())
print(someIterator.next())
 
```

## é‚£ç¬¬ä¸‰å€‹å•é¡Œï¼Œä¸èƒ½æŠŠ PAT æ”¾å…¥ collection å‘¢ï¼Ÿ

æŠ±æ­‰ï¼Œé‚„ç„¡æ³•ğŸ¤·â€â™‚ï¸

## æ›´å¤š weak self

* ä¸»æŒäºº [ä¸€ä¸‰](https://twitter.com/ethanhuang13)ã€[æ³¢è‚¥](https://twitter.com/PofatTseng)ã€[å–¬å–¬](https://twitter.com/joe_trash_talk)
* å®˜ç¶² [https://weakself.dev](https://weakself.dev)
* Twitter [@weak_self](https://twitter.com/weak_self)
* [æå•ç®±](https://peing.net/zh-TW/weak_self)